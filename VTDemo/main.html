
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<title>VOXTOX</title>
		<meta name="description" content="VoxTox">
		<meta name="author" content="Sam">
		<script src="resource/js/game.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		
	</head>

	<body>
		<div>
			<header>
				<h1>VOXTOX</h1>
			</header>
			<canvas id="render"width="1000"height="400"></canvas>
            <input type="button" onclick="Iradiate()" />
			<script type="text/javascript">
			    var DEBUG = true;
				if(typeof console == "undefined"){
					DEBUG = false;
				}
				var canvas = document.getElementById('render');
				var ctx = canvas.getContext("2d");
				var Fired = false;
				var worlds = new World(0, 0);
				function LoadWorld(files)
				{
					var succed = true;
					$.when($.ajax({//Loading function
						url:"resource/xml/"+files+".xml",
						dataType:"xml",
						async:false,
						success:function(xml) {
							//if(DEBUG){console.log("load");}
							var xml = $('xml',xml);
							worlds = new World(parseInt(xml.find("Xsize").text()), parseInt(xml.find("Ysize").text()));
							var Ofset = 100;
							$("#render").attr("width", worlds.SizeX * 20 + Ofset);
							$("#render").attr("height", worlds.SizeY * 20 + Ofset);
							$(xml).find("type").each(function(){
								var Set = 0;
								$(this).find("celltype").each(function(){
									worlds.Types[Set] = new CellType();
									worlds.Types[Set].Id = parseInt($(this).find("id").text());
									worlds.Types[Set].Name = $(this).find("name").text();
									worlds.Types[Set].RadLim = parseFloat($(this).find("rad").text());
									worlds.Types[Set].Col = parseInt($(this).find("colour").text());
									worlds.Types[Set].Weight = parseInt($(this).find("weight").text());
									Set += 1;
								});
							});
							$(xml).find("data").each(function(){
								Set = 0;
								$(this).find("cell").each(function(){
									worlds.Cells[Set].Type = parseInt($(this).text());
									worlds.Cells[Set].Y = (~~(Set/worlds.SizeX)+1);
									worlds.Cells[Set].X = (( ((Set/worlds.SizeX) - (worlds.Cells[Set].Y-1)) * worlds.SizeX) +1);
									worlds.Cells[Set].Y *= 20.0;
									worlds.Cells[Set].X *= 20.0;
									worlds.Cells[Set].X -= 10.0 - Ofset/2;
									worlds.Cells[Set].Y -= 10.0 - Ofset/2;
									if(DEBUG){console.log("X,%f:Y,%f,Id:%f",worlds.Cells[Set].X,worlds.Cells[Set].Y,Set);}
									Set += 1;
								});
							});
							succed = true;
							return;
						},
						error:function(err) {
							succed = false;
							if(DEBUG){console.log("failed");}
						}
					})).then(function ()
					{
						if(DEBUG){console.log("loaded");}
						return succed;
					});
					if(DEBUG){console.log("may loaded");}
					return succed;
				}
				function MainLoop()
				{
					if(worlds.Clear == true)//clear if updated
					{
						ctx.clearRect(0,0,$(canvas).width(),$(canvas).height());
						worlds.Clear = false;
					}
					if (Fired == true) {
					    worlds.Fire();
					    Fired = false;
					}
					//world.Update();
					//if(DEBUG){console.log("clear");}
					for(var i = 0;i <worlds.CellCount;++i)
					{
						if(worlds.CellRender[i] == true)
						{
							if(typeof worlds.Cells[i] != "undefined")
							{
								if(typeof worlds.Types[worlds.Cells[i].Type] != "undefined")
								{
								    ctx.fillStyle = shadeColor(worlds.ColourArr[worlds.Types[worlds.Cells[i].Type].Col], - worlds.Cells[i].Rad);//Render
									ctx.fillRect(worlds.Cells[i].X,worlds.Cells[i].Y,20,20); 
									worlds.CellRender[i] = false;
								}
							}
						}
					}
					for (var i = 0; i < 3; ++i) {
					    if (worlds.RadsRender[i] == true) {
					        //if (typeof worlds.Rads[i] != "undefined") {
					        ctx.fillStyle = "#FF0000";
					        ctx.fillRect(worlds.Rads[i].SX + worlds.Rads[i].X, worlds.Rads[i].SY + worlds.Rads[i].Y, 20, 20);
					        worlds.RadsRender[i] = false;
					        //}
					    }
					}

					setTimeout("MainLoop()",200);
				}
				$("#render").mousedown(function (e)
				{
				    e.pageX = $("#render").attr("width") - e.pageX;
				   // e.pageY = $("#render").attr("height") - e.pageY;
				    for (var i = 0; i < 1; ++i) {
				        var Xdis = e.pageX - worlds.Rads[i].SX + worlds.Rads[i].X;
				        var Ydis = e.pageY - worlds.Rads[i].SY + worlds.Rads[i].Y;
				        var DDis = Math.sqrt((Xdis * Xdis) + (Ydis * Ydis));
				        if (DDis < 400) {
				            //alert(DDis);
				            worlds.Rads[i].UpdatePos(e.pageX, e.pageY);
				            worlds.RadsRender[i] = true;
				        }
				    }
				});
				$( document ).ready(function (){
				    //if(DEBUG){console.log("built world");}
					if(LoadWorld("Big") == true)
					{
						alert("loading Complete");
						MainLoop();
					}
					else
					{
						alert("load failed");
					}
				});
				function shadeColor(color, percent) {
				    var num = parseInt(color.slice(1), 16), amt = Math.round(2.55 * percent), R = (num >> 16) + amt, B = (num >> 8 & 0x00FF) + amt, G = (num & 0x0000FF) + amt;
				    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (B < 255 ? B < 1 ? 0 : B : 255) * 0x100 + (G < 255 ? G < 1 ? 0 : G : 255)).toString(16).slice(1);
				}
				function Iradiate() {
				    for (var i = 0; i < worlds.CellCount; ++i) {
				        if (worlds.Cells[i].Type != 0) {//If is not air
				            worlds.Cells[i].Rad += 10;
				            worlds.CellRender[i] = true;
				        }
				    }
				}
			</script>
			<footer>
				<p>
				</p>
			</footer>
		</div>
	</body>
</html>
